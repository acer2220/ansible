---
- hosts: all

  become: true

  tasks:
    - name: Update package lists
      apt:
        update_cache: yes
      changed_when: false
    - name: Upgrade all packages
      apt:
        upgrade: dist
        autoremove: yes
        autoclean: yes
    - name: Update Pi-hole
      command: pihole -up
      register: pihole_update_result
      changed_when: "'Everything is already up to date' not in pihole_update_result.stdout"
    - name: Display Pi-hole update results
      debug:
        var: pihole_update_result.stdout_lines
    - name: Check Pi-hole status
      command: pihole status
      register: pihole_status
      changed_when: false
    - name: Verify DNS resolution is working
      command: dig @localhost google.com
      register: dns_test
    - name: hostname
      command: hostname
      register: hostname_host
      changed_when: false
      failed_when: "'ANSWER SECTION' not in hostname_host.stdout"
        
    - name: Send update completion notification
      mail:
        host: smtp.gmail.com
        port: 587
        username: workgcannon@gmail.com
        password: "xscj expv qrzi zbay"
        to: workgcannon@gmail.com
        subject: "\n\n{{ hostname_host.stdout }} Pi-hole update completed."
        body: "Updates have been applied to all Pi-hole instances.\n\n{{ pihole_update_result.stdout }} \n\n{{ pihole_status.stdout }} \n\n{{ dns_test.stdout }}"
      when: pihole_update_result.changed
      no_log: true
      vars:
        ansible_python_interpreter: /usr/bin/python3
      delegate_to: localhost
